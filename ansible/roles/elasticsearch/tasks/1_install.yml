- name: Download Elasticsearch .deb package
  ansible.builtin.get_url:
    url: "https://artifacts.elastic.co/downloads/elasticsearch/{{ elastic_search_version }}"
    dest: "/tmp/{{ elastic_search_version }}"
    mode: '0644'
- name: Download Elasticsearch checksum file
  ansible.builtin.get_url:
    url: "https://artifacts.elastic.co/downloads/elasticsearch/{{ elastic_search_version }}.sha512"
    dest: "/tmp/{{ elastic_search_version }}.sha512"
    mode: '0644'
- name: Verify checksum of the downloaded package
  ansible.builtin.shell: |
    cd /tmp
    sha512sum -c "{{ elastic_search_version }}.sha512"
  register: checksum_output
  failed_when: checksum_output.rc != 0
- name: Install Elasticsearch deb package
  dpkg:
    name: "/tmp/{{ elastic_search_version }}"
    state: present
- name: Ensure Elasticsearch is started and enabled
  ansible.builtin.systemd:
    name: elasticsearch
    state: started
    enabled: yes
- name: Configure Elasticsearch settings
  ansible.builtin.template:
    src: "elasticsearch.yml.j2"
    dest: "/etc/elasticsearch/elasticsearch.yml"
    mode: '0644'
    owner: root
    group: root
- name: Set JVM heap size
  ansible.builtin.lineinfile:
    path: "/etc/elasticsearch/jvm.options"
    regexp: "^#?-Xms.*"
    line: "-Xms2g"
    state: present
- name: Enable memory locking
  ansible.builtin.lineinfile:
    path: "/etc/elasticsearch/elasticsearch.yml"
    regexp: "^#?bootstrap.memory_lock"
    line: "bootstrap.memory_lock: true"
    state: present