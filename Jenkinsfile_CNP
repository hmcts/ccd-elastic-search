#!groovy
@Library("Infrastructure") _

import uk.gov.hmcts.contino.Environment
import uk.gov.hmcts.contino.HealthChecker
import uk.gov.hmcts.contino.azure.KeyVault

properties([
        parameters([
                string(name: 'PRODUCT_NAME', defaultValue: 'ccd-elastic-search', description: ''),
                booleanParam(name: 'DEPLOY_ES_CLUSTER', defaultValue: false, description: 'Select to deploy ElasticSearch'),
                booleanParam(name: 'RUN_ANSIBLE_DRY', defaultValue: false, description: 'Run Ansible in DRY run mode'),
                booleanParam(name: 'RUN_ANSIBLE_APPLY', defaultValue: false, description: 'Run Ansible in APPLY mode'),
                booleanParam(name: 'UPGRADE_ES', defaultValue: true, description: 'Whether to run ES version upgrade steps (deb packages re-deploy)'),
                booleanParam(name: 'ROLLING_UPGRADE', defaultValue: false, description: 'Run Ansible with rolling upgrade steps (demo-int only)'),
                booleanParam(name: 'REINDEX', defaultValue: false, description: 'Whether to re-index after version upgrade (demo-int only)'),
        ])
])

def setupSecret() {
  def bootstap_env = env.ENV
  azureKeyVault(
    keyVaultURL: "https://ccd-${bootstap_env}.vault.azure.net/",
    secrets: [
      secret("ccd-vm-admin-name", 'CCD_VM_ADMIN_NAME'),
      secret("ccd-ELASTIC-SEARCH-PRIVATE-KEY", 'CCD_VM_SSH_PRIVATE_KEY'),
    ]) {
      env.CCD_VM_ADMIN_NAME = "${CCD_VM_ADMIN_NAME}"
      env.CCD_VM_SSH_PRIVATE_KEY = "${CCD_VM_SSH_PRIVATE_KEY}"
    }
}

def runAnsible() {

    setupSecret()
    echo "ANSIBLE Dry run: " + params.RUN_ANSIBLE_DRY
    echo "ANSIBLE Apply run: " + params.RUN_ANSIBLE_APPLY
    echo "Rolling upgrade (demo-int only): " + params.ROLLING_UPGRADE
    echo "Upgrade ES (demo-int only): " + params.UPGRADE_ES
    echo "Reindex (demo-int only): " + params.REINDEX
    sh "echo 'Running Ansible Playbook for Sandbox'"

    // Install regular Ansible for normal environments
    sh "sudo apt update && sudo apt install -y ansible python3-venv"
    sh "ansible --version"
    sh "echo 'environment ${env.ENV}'"

    writeFile file: '/tmp/ccdadmin_key', text: "${CCD_VM_SSH_PRIVATE_KEY}"
    sh "chmod 600 /tmp/ccdadmin_key"
    def checkRunAnsible = "--check"
    if (params.RUN_ANSIBLE_APPLY == true) {
        checkRunAnsible = ""
    }
    def rollingUpgradeDemoInt = params.ROLLING_UPGRADE ? "true" : "false"
    def reindex = params.REINDEX ? "true" : "false"
    def upgradeEs = params.UPGRADE_ES ? "true" : "false"

    // Run regular demo environment with standard Ansible
    // Temporarily disabled to save time during demo-int builds
    // sh "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ${WORKSPACE}/ansible/inventory.ini ansible/diskmount.yml -u ${CCD_VM_ADMIN_NAME} --private-key=/tmp/ccdadmin_key --limit ${env.ENV} ${checkRunAnsible}"

    // sh "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ${WORKSPACE}/ansible/inventory.ini ansible/main.yml -u ${CCD_VM_ADMIN_NAME} --private-key=/tmp/ccdadmin_key --limit ${env.ENV} --extra-vars 'elastic_clustername=ccd-elastic-search-${env.ENV}' ${checkRunAnsible}"

    // For demo-int only: use Ansible 2.9 with Python 3.9 in virtualenv (supports Python 3.5 targets)
    if (env.ENV == 'demo' && readFile("${WORKSPACE}/demo.tfvars").contains('enable_demo_int = true')) {
        sh """
            # Install Python 3.9 if not present
            # Commented out as this python fails certs checks while downloading packages
            # sudo apt install -y python3.9 python3.9-venv

            # Create virtualenv with system's Python 3 and Ansible for demo-int (Ubuntu 24.04 compatible)
            python3 -m venv /tmp/ansible-venv
            /tmp/ansible-venv/bin/pip install --upgrade pip
            /tmp/ansible-venv/bin/pip install ansible==13.0.0
            /tmp/ansible-venv/bin/ansible --version

            # Run demo-int with Ansible
            ANSIBLE_HOST_KEY_CHECKING=False /tmp/ansible-venv/bin/ansible-playbook -i ${WORKSPACE}/ansible/inventory.ini ansible/diskmount.yml -u ${CCD_VM_ADMIN_NAME} --private-key=/tmp/ccdadmin_key --limit demo_int ${checkRunAnsible}
            ANSIBLE_HOST_KEY_CHECKING=False /tmp/ansible-venv/bin/ansible-playbook -i ${WORKSPACE}/ansible/inventory.ini ansible/main.yml \
                -u ${CCD_VM_ADMIN_NAME} \
                --private-key=/tmp/ccdadmin_key \
                --limit demo_int \
                --extra-vars 'elastic_clustername=ccd-elastic-search-demo-int rolling_upgrade=${rollingUpgradeDemoInt} reindex=${reindex} upgrade_es=${upgradeEs}' ${checkRunAnsible}

            # Cleanup
            rm -rf /tmp/ansible-venv
        """
    }
}

static Map<String, Object> secret(String secretName, String envVariable) {
  [
    $class     : 'AzureKeyVaultSecret',
    secretType : 'Secret',
    name       : secretName,
    envVariable: envVariable
  ]
}

if (params.DEPLOY_ES_CLUSTER == true) {
   withInfraPipeline(params.PRODUCT_NAME) {
     onMaster {
           enableSlackNotifications('#ccd-master-builds')
       }
       onDemo {
           enableSlackNotifications('#ccd-demo-builds')
       }



       // TODO: Healthcheck per env
//        afterAlways('buildinfra:aat') {
//            echo 'Healthcheck in AAT'
//            healthCheckStage('nonprod', 'aat')
//        }
//        afterAlways('buildinfra:prod') {
//            echo 'Healthcheck in PROD'
//            healthCheckStage('prod', 'prod')
//        }
//        afterAlways('buildinfra:perftest') {
//            echo 'Healthcheck in Perftest'
//            healthCheckStage('qa', 'perftest')
//        }
//        afterAlways('buildinfra:demo') {
//            echo 'Healthcheck in Perftest'
//            healthCheckStage('nonprod', 'demo')
//        }
//        afterAlways('buildinfra:ithc') {
//            echo 'Healthcheck in Perftest'
//            healthCheckStage('qa', 'ithc')
//        }



   if (params.RUN_ANSIBLE_DRY == true || params.RUN_ANSIBLE_APPLY == true) {

        afterSuccess('buildinfra:demo') {
            echo 'running Ansible in Demo '
            env.ENV = 'demo'
            runAnsible()
        }
   }
 }
}

def healthCheckStage(subscription, environmentName) {
    stage('HealthCheck') {
        def healthChecker = new HealthChecker(this)
        healthChecker.check(healthCheckUrl(subscription, environmentName), 10, 40) { response ->
            if (response.content.contains("yellow")) {
                currentBuild.result = "UNSTABLE"
            }
            !response.content.contains("red")
        }
    }
}

def healthCheckUrl(subscription, environmentName) {
    KeyVault keyVault = new KeyVault(this, subscription, "ccd-$environmentName")
    es_url = keyVault.find("ccd-ELASTIC-SEARCH-URL").trim()
    echo "retrieved ES URL: ${es_url}"
    "http://" + es_url + ":9200/_cluster/health"
}
